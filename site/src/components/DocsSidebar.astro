---
import { getData } from '@libs/data'
import { getConfig } from '@libs/config'
import { docsPages } from '@libs/content'
import { getSlug } from '@libs/utils'

const sidebar = getData('sidebar')
---

<nav class="cxd-links w-100" id="cxd-docs-nav" aria-label="Docs navigation">
  <ul class="cxd-links-nav bulletless mb-0 pb-medium pb-medium-2 pe-large-2">
    {
      sidebar.map((group) => {
        const groupSlug = getSlug(group.title)

        if (group.pages) {
          return (
            <li class:list={['cxd-links-group py-xsmall', groupSlug === Astro.params.slug?.split('/')[0] ? 'active' : undefined]}>
              <strong class="cxd-links-heading d-flex w-100 align-items-center fw-semibold">
                {group.icon && (
                  <svg
                    class="bi me-xsmall"
                    style={group.icon_color && `color: var(--cx-${group.icon_color});`}
                    aria-hidden="true"
                  >
                    <use xlink:href={`#${group.icon}`} />
                  </svg>
                )}
                {group.title}
              </strong>
              <ul class="bulletless fw-normal pb-xsmall small">
                {group.pages?.map((page) => {
                  const docSlug = getSlug(page.title)
                  const unversionedPageSlug = `${groupSlug}/${docSlug}`

                  const url = `/${unversionedPageSlug}`
                  const active = Astro.params.slug === unversionedPageSlug

                  const generatedPage = docsPages.find((page) => page.slug === unversionedPageSlug)

                  // This test should not be necessary, see comments for `getSlug()` in `src/libs/utils.ts`.
                  if (!generatedPage) {
                    throw new Error(
                      `The page '${page.title}' referenced in 'site/data/sidebar.yml' does not exist at '${url}'.`
                    )
                  }

                  return (
                    <li>
                      <a
                        href={url}
                        class:list={['cxd-links-link d-inline-block rounded', { active }]}
                        aria-current={active ? 'page' : undefined}
                      >
                        {page.title}
                      </a>
                    </li>
                  )
                })}
              </ul>
            </li>
          )
        } else {
          const active = Astro.params.slug === groupSlug

          return (
            <>
              <li class="cxd-links-span-all mt-2xsmall mb-medium mx-large border-top" />
              <li class="cxd-links-span-all">
                <a
                  href={`/docs/${getConfig().docs_version}/${groupSlug}/`}
                  class:list={['cxd-links-link d-inline-block rounded small', { active }]}
                  aria-current={active ? 'page' : undefined}
                >
                  {group.title}
                </a>
              </li>
            </>
          )
        }
      })
    }
  </ul>
</nav>
